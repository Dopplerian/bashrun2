# -*- shell-script -*-

BASHRUN_PLUGIN_DIRS="$BASHRUN_CONFIG_HOME/plugins $BASHRUN_CONFIG_DIRS/plugins"
BASHRUN_PLUGINS_CHECKED="$BASHRUN_CACHE_HOME/plugins-checked"

function §plugin.find {

    local wanted="${1}"
    local dir=""
    local file=""

    for dir in $BASHRUN_PLUGIN_DIRS; do
	file="$dir/${wanted}.rc"
	[[ -f "$file" ]] && echo "$file"
    done
}

function §plugin.check {
    local file="$1"
    local retval=0
    declare -i i

    §syntax? $file
    retval=$?
    
    if ! §plugin.checked? "$file"; then
	echo "$file" >> $BASHRUN_PLUGINS_CHECKED
    fi
    return $retval
}

function §plugin.checked? {
    grep "$1" "$BASHRUN_PLUGINS_CHECKED" &>/dev/null
}

function +plugins { 
    local file=""
    local name=""
    local errors=""
    for name in $*; do
	file="$(§plugin.find "$name")"
	if [[ -n "$file" ]]; then
	    if ! §plugin.checked? "$file"; then
		if ! §plugin.check "$file"; then
		    errors="$(<$BASHRUN_CACHE_HOME/errors)"
		    errors="${errors//$'\n'/\\n}"
		    §message "Syntax Errors" \
			"The plugin file $(§tilde_path $file) contains syntax errors:

                         $errors

                         Skipping plugin \"$name\"..."
		else
		    §debug "using plugin" -c "$(§tilde_path $file)"
		    source "$file"
		fi
	    else
		if §plugin.check "$file"; then
		    §debug "using plugin" -c "$(§tilde_path $file)"
		    source "$file"
		fi
	    fi
	else
	    if §window.terminal?; then
		§message "Error" \
		    "Plugin \"$name\" not found: no such file(s):

                     $(§tilde_path $BASHRUN_CONFIG_HOME/plugins)/$name.rc\n
                     $BASHRUN_CONFIG_DIRS/plugins/$name.rc"
	    fi
	fi
    done
}

§function.clone "+plugins" "+plugin"
