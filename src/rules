# -*- shell-script -*-

################################################################################

§class "§rule" "name progs" "match"

bashrun_rules_applied=0

################################################################################

function §rule.match {

    local progs="$(§rule.get_progs)"
    if [[ -z "$progs" ]]; then
	progs="$@"
    else
	progs="$progs $@"
    fi
    §rule.set_progs "$progs"
}

function §rules.apply {

    §command.get_word

    [[ bashrun_rules_applied -eq 1 ]] && return 0

    local action=$(§actions.current)
    local word="$bashrun_command_word"
    local command="$bashrun_command"
    local rules rule progs prog regexp 

    # move the term-run rule to the end of rules
    local rules="$(§rules.all)"
    rules="${rules/term-run/} term-run"

    §debug "applying rules..."

    for rule in $rules; do
	§rules.seek "$rule"
	progs="$(§rule.get_progs)"

	# implicitly add all terminal --match progs to the end of
	# the term-run rule:
	if [[ "$rule" == "term-run" ]]; then
	    progs+=" $(§terminals.get_match)"
	fi

	for prog in $progs; do

	    if [[ "$word" == "$prog" ]]; then
		# literal match

		§debug -v "$word" "==" -v "$prog" "->" -y "$rule"
		bashrun_rules_applied=1

		if §actions.seek "$rule"; then
		    §action.run
		fi
		return 0
	    else
		if [[ "$prog" =~ /.+?/ ]]; then
		    # regexp given
		    regexp=${prog:1:${#prog}-2}

		    # match the whole command against regexp
		    if [[ "$command" =~ $regexp ]]; then
			# regexp match
		
			§debug -v "'$command'" "=~" -v "$prog" \
			          "->" -y "$rule"
			bashrun_rules_applied=1

			if §actions.seek "$rule"; then
			    §action.run
			fi
			return 0
		    fi
		fi
	    fi
	done
    done
    §rules.seek_start

    # no rule applied if we end up here
    return 1
}

function §rules.applied? {

    [[ bashrun_rules_applied -eq 1 ]] && return 0
    [[ bashrun_rules_applied -eq 0 ]] && return 1
}

function §rule.code {

    local name=$(§rule.get_name)
    local progs=$(§rule.get_progs)
    local program=''

    name=${name//\'/\\\'}
    progs=${progs//\'/\\\'}

    echo "+rule '$name'"
    echo "  --match '$progs'"
}
