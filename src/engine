# -*- shell-script -*-

################################################################################

BASHRUN_COMMAND=''

object "action" "name type desc"

function bashrun_engine_init {
    
    # setup
    bashrun_engine_install_directories
    
    # escape from trap in interactive mode
    PROMPT_COMMAND="trap DEBUG; $PROMPT_COMMAND"
}

function bashrun_engine_perform_action {

    local action=$1      # action to perform
    local type=$2        # action type override
    local command=$3     # command override

    if actions_seek $action; then
	
	bashrun_log "action: $action"

	# type override
	[[ $type == '' ]] && type=$(action_type)

	bashrun_log "type: $type"

	# dispatch action according to type
	case $type in
	    
	    trap)
	        # set the trap
		trap bashrun_engine_trap DEBUG
		;; 
	    
	    run)
		# command override
		[[ $command == '' ]] && command=':'
     
		# run command directly
		bashrun_engine_run $command
		;;
	    
	    call)
		# call action directly
		if $(type -t bashrun-action-$action &> /dev/null); then		    
		    bashrun-action-$action
		fi
		;;
	    *)
		bashrun_log "no such action type: $type"
		;;
	esac
    else
	bashrun_log "no such action: $action"
    fi
}

function bashrun_engine_trap {
    :
}

function bashrun_engine_run {

    local command=$1

    # command override
    if [[ $command != '' ]]; then
	BASHRUN_COMMAND=$command
    fi
    bashrun_log BASHRUN_COMMAND
}

function bashrun_engine_install_directories {

    # create XDG directories
    local dir
    for dir in 'CONFIG' 'DATA' 'CACHE'; do

	dir="BASHRUN_${dir}_HOME"
	dir=${!dir}
	
	if [[ ! -d $dir ]]; then
	    bashrun_log "$dir"
	    install -d -m 700 $dir
	fi
    done
}

function bashrun_engine_shutdown {
    
    bashrun_remote_cleanup    
}    
