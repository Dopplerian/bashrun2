# -*- shell-script -*-

################################################################################

BASHRUN_READLINE=()

function §readline.get_bindings {

    local restore=$IFS
    IFS=$'\n' 
    BASHRUN_READLINE=($(bind -p; bind -s))
    IFS=$restore
}

function §readline.get_binding {

    local keyseq=$1
    local line='';
    local i=0

    for (( i=0; i<${#BASHRUN_READLINE[@]}; i+=1 )); do
	line=${BASHRUN_READLINE[$i]}
	[[ "$line" =~ ^# ]] && continue

	if [[ "$line" =~ .?${keyseq}\" ]]; then # FIXME: regexp ^ ?!
	    echo $line
	    return 0
	fi
    done    
}

function §readline.rebind {
    local keyseq=$1
    local keymap=${2:-emacs}
    local readline=$(§readline.get_binding $keyseq)
    readline=${readline//\'/\\x27}
    
    local binding="-m $keymap '$readline'"    

    if [[ "$readline" != '' ]]; then 
	§debug "bind $binding"
	eval "bind $binding"
    else
	§debug "$keyseq: no previous binding"
    fi
}
