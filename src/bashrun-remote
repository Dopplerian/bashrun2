#!/bin/bash

BASHRUN_PREFIX=`which bashrun 2> /dev/null`
BASHRUN_PREFIX=${BASHRUN_PREFIX/\/bin\/bashrun/}
BASHRUN_SHARE="$BASHRUN_PREFIX/share/bashrun-engine"

. $BASHRUN_SHARE/frontend

mode="${1:-launcher}"
wid="$(bashrun.registry.find $mode)"
num="$(bashrun.registry.length)"

if [[ "$wid" != "none" ]]; then    
    
    bashrun.window.id "$wid"
    modes.seek "$mode"
    bashrun.window.toggle

else
    # get the bashrun terminal
    terminals.seek "bashrun"

    # get requested mode
    if ! modes.seek "$mode"; then
	echo "$0: warning: no such mode '$mode', using 'launcher'" 

        # startup mode defaults to launcher
	mode="launcher"
	modes.seek $mode
    fi

    # find out whether this mode has feedback enabled
    feedback="$(mode.get_feedback)"

    # find out whether it's animated
    animation="$(mode.get_anim)"

    # get command and insert properties and geometry from requested mode
    geometry=$(mode.get_geom | cut -d ' ' -f 1)
    geometry.parse $geometry

    if [[ animation -eq 1 ]]; then
	# start with a one line terminal
	geometry.height 1
	geometry="$(geometry)"
    fi

    command="$(terminal.get_command)"

    command=${command//%m/$mode}
    command=${command//%g/$geometry}        

    # launch terminal
    BASHRUN_FEEDBACK="$feedback" BASHRUN=1 BASHRUN_MODE="$mode" $command &    

    wid="$(get_wid $num)"
    bashrun.window.id "$wid"

    # map the window to make it expand if animated
    bashrun.window.map
fi
