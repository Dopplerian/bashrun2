#!/bin/bash

BASHRUN_PREFIX=`which bashrun-remote 2> /dev/null`
BASHRUN_PREFIX=${BASHRUN_PREFIX/\/bin\/bashrun-remote/}
BASHRUN_SHARE="$BASHRUN_PREFIX/share/bashrun-engine"

mode="launcher"
command="show"

# Fast handling of 'bashrun [--mode <mode>] [show|hide|toggle|smart]'

if [[ $# -eq 3 || $# -eq 2 ]]; then
    if [[ "$*" =~ ^(\-\-mode|-m)\ ([^\ ]+) ]]; then
	mode=${BASH_REMATCH[2]}
	shift; shift
    fi
fi

if [[ $# -eq 1 ]]; then
    case $1 in
	show|--show|hide|--hide|toggle|--toggle|smart|--smart|wid|--wid)
	    command=$1
	    shift
	    ;;
    esac    
fi

if [[ $# -eq 0 ]]; then            
    source $BASHRUN_SHARE/simple
    [[ $? -eq 0 ]] && exit 0
fi

# The above usage didn't apply or no instance was found in the specified mode...

version () {
    echo "bashrun $BASHRUN_VERSION Copyright (C) 2009 Henning Bekel <h.bekel@googlemail.com>"
}

usage () {
    echo "Usage: bashrun [option] [[command[:modifier]] [args]...]

  Options: 

    -v, --version : show version information and exit
    -h, --help    : show this message and exit
    -m, --mode    : select mode to launch/control

  Commands: 
       
    show     : show (map) window, move to current desktop  and focus it
    hide     : hide (unmap) window 
    toggle   : hide if visible, show if hidden
    smart    : move window up front if not focused/visible, hide otherwise  
    exit     : exit instance
    wid      : print window id
    pid      : print pid of bashrun session
    wait     : wait until window is mapped/unmapped

    su[:user|?] <cmd>     : run <cmd> as user (?=ask) (default: 'su:root')
    action <action> <cmd> : invoke <action> for <cmd>
"
}

# handle option first
case "$1" in
    -v|--version)
	version && exit 0
	;;
    -h|--help)
	usage && exit 0
	;;    
    -m|--mode)
	mode=${2:-launcher}
	shift; shift
	;;
esac

echo "frontend: remaining args: $*"

source $BASHRUN_SHARE/frontend

response="$(§registry.request $mode)"

if [[ "$response" == "new" ]]; then    
    wid="$(launch)"
else
    wid="$response"
fi

§window.id "$wid"

[[ $# -gt 0 ]] && command="$1"

case "$command" in
    wid)
	echo "$wid"
	;;
    show)
	§window.map
	;;
    hide)
	§window.unmap
	;;	
    toggle)
	[[ "$response" != "new" ]] && §window.toggle
	;;
    *)
	echo "bashrun: command '$command' unknown or not implemented"
	exit 1
esac
exit 0
